const fs = require('fs');
const path = require('path');

// Función recursiva para encontrar todos los archivos .spec.ts
function findSpecFiles(dir, fileList = []) {
  const files = fs.readdirSync(dir);
  
  files.forEach(file => {
    const filePath = path.join(dir, file);
    const stat = fs.statSync(filePath);
    
    if (stat.isDirectory() && !filePath.includes('node_modules')) {
      findSpecFiles(filePath, fileList);
    } else if (file.endsWith('.spec.ts')) {
      fileList.push(filePath);
    }
  });
  
  return fileList;
}

// Obtener el directorio del proyecto (donde está package.json)
const projectRoot = __dirname.replace(/[\\/]scripts$/, '');
process.chdir(projectRoot);

// Encontrar todos los archivos .spec.ts en src/
const specFiles = findSpecFiles('src');

// Generar los imports
const imports = specFiles
  .map(file => {
    // Convertir la ruta a relativa desde src/
    const relativePath = path.relative('src', file).replace(/\\/g, '/');
    // Remover la extensión .ts
    const importPath = relativePath.replace(/\.ts$/, '');
    return `import './${importPath}';`;
  })
  .join('\n');

// Contenido del archivo test.ts
const testFileContent = `// This file is required by karma.conf.js and loads recursively all the .spec and framework files
// This file is auto-generated by scripts/generate-test-imports.js
// Run: node scripts/generate-test-imports.js

import 'zone.js/testing';
import { getTestBed } from '@angular/core/testing';
import {
  BrowserDynamicTestingModule,
  platformBrowserDynamicTesting
} from '@angular/platform-browser-dynamic/testing';

// First, initialize the Angular testing environment.
getTestBed().initTestEnvironment(
  BrowserDynamicTestingModule,
  platformBrowserDynamicTesting(),
  {
    teardown: { destroyAfterEach: false }
  }
);

// Then we find all the tests.
// Webpack 5 doesn't support require.context, so we import all spec files explicitly
// Auto-generated imports:
${imports}
`;

// Escribir el archivo
fs.writeFileSync('src/test.ts', testFileContent, 'utf8');
console.log(`✅ Generated src/test.ts with ${specFiles.length} test file imports`);
specFiles.forEach(file => console.log(`   - ${file}`));

